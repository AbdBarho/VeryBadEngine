<!DOCTYPE html>
<html lang="en">

<head>
  <title>Very Bad Engine</title>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000" />
  <meta name="Description" content="An in-browser game engine made with TypeScript">
  <style>*{margin:0;padding:0}body,html{width:100%;height:100%;background-color:#000}#state,canvas{position:absolute}h1{color:#fff}#state{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;padding:5px;top:0;left:0;user-select:none;background:rgba(255,255,255,.8);min-width:160px;z-index:999999}</style>
</head>

<body>
  <div id="state"></div>
  <script defer>(()=>{"use strict";const t={LOGGER:{VERBOSITY:0},CANVAS:{WIDTH:1920,HEIGHT:1080}};t.CANVAS.WIDTH=window.innerWidth,t.CANVAS.HEIGHT=window.innerHeight;const e=t;function s(t=0,e=0){return{x:t,y:e}}class i{constructor(){this.__listeners__={},this.__all__listeners=[]}on(t,e,s){this.__listeners__[t]=this.__listeners__[t]||[],this.__listeners__[t].push({callback:e,context:s})}onAll(t,e){this.__all__listeners.push({callback:t,context:e})}once(t,e,s){const i=(...n)=>{e.apply(s,n),this.off(t,i)};this.on(t,i,s)}off(t,e){const s=this.__listeners__[t];for(let t=0;t<s.length;t++)s[t].callback===e&&s.splice(t--,1)}offAll(t){const e=this.__all__listeners;for(let s=0;s<e.length;s++)e[s].callback===t&&e.splice(s--,1)}trigger(t,...e){const s=this.__listeners__[t]||[];for(let t=0;t<s.length;t++)s[t].callback.apply(s[t].context,e);const i=this.__all__listeners;for(let s=0;s<i.length;s++)i[s].callback.apply(i[s].context,[t,...e])}}class n extends i{constructor(){super(...arguments),this.queue=[]}queueEvent(t,...e){this.queue.push({event:t,parameters:e})}executeQueue(){if(0===this.queue.length)return;const t=this.queue;this.queue=[];for(let e=0,s=t.length;e<s;e++){const s=t[e];this.trigger(s.event,...s.parameters)}}emptyQueue(){this.queue=[]}}const o=e.LOGGER.VERBOSITY;let r={};const a=document.getElementById("state");let h=0,c=0,l=[];class u{static fps(t){h++,c+=t,l.push(t),c<1e3?l.length>300&&this.showFPSDebug():(this.debugInfo("FPS",(1e3*h/c).toFixed(2)),c=0,h=0)}static getAvgFPS(){return l.reduce((t,e)=>t+e,0)/l.length}static showFPSDebug(){const t=(1e3/u.getAvgFPS()).toFixed(2);l=[],u.debugInfo("AVG FPS",t)}static debugInfo(t,e){r[t]=e,this.renderDebug()}static renderDebug(){let t="";for(let[e,s]of Object.entries(r))t+=e+": "+s+"\n";a.innerText=t}static debugState(t){t=Object.assign({},t);for(let e in t)t[e]=t[e].toString();for(let[e,s]of Object.entries(t))this.debugInfo(e,s)}}-1===o&&(u.debugInfo=()=>{},u.renderDebug=()=>{},a.remove());const d=2*Math.PI;function p(t){return t/1e3}function y(t){return t/1e6}function f(t,e){return Math.atan2(-e,t)}function m(t,e){let s=f(e.x-t.x,e.y-t.y);return{x:Math.cos(s),y:-Math.sin(s)}}function x(t,e=0){return Math.floor(Math.random()*(t-e))+e}function g(){return"#"+S(x(256))+S(x(256))+S(x(256))}function S(t){return(t<16?"0":"")+t.toString(16)}function w(t=0,e=1){let s=Math.random();return Math.random()<.5?t+s*e:-s*e-t}function E(t){t.x=0,t.y=0}function v(t,e){let s=t.x*t.x+t.y*t.y;if(s>e*e){let i=Math.sqrt(s);t.x=e*t.x/i,t.y=e*t.y/i}}function M(t,e,s){return(1-s)*t+s*e}class b{constructor(t){this.canvas=t,this.buffer=document.createElement("canvas"),this.buffer.width=t.size.x,this.buffer.height=t.size.y;const e=this.buffer.getContext("2d");if(null===e)throw"No context could be created for the off screen canvas";this.ctx=e}getBuffer(){return this.buffer}getContext(){return this.ctx}setDimensions(t,e){this.buffer.width=t.x,this.buffer.height=t.y,this.buffer.style.top=e.y+"px",this.buffer.style.left=e.x+"px"}clear(){const t=this.canvas.size;this.ctx.clearRect(0,0,t.x,t.y)}alpha(t){this.ctx.globalAlpha=t}debugPoint(t,e,s,i){this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(t,e,s,0,2*Math.PI),this.ctx.fill(),this.ctx.closePath()}fillWith(t){this.fillStyle(t);const e=this.canvas.size;this.ctx.fillRect(0,0,e.x,e.y)}fillStyle(t){this.ctx.fillStyle=t}renderGradientData(t){const e=this.ctx.createLinearGradient(...t.points);for(let s=0;s<t.stops.length;s++)e.addColorStop(t.stops[s],t.colors[s]);this.fillWith(e)}drawImage(t,e,s,i,n){this.ctx.drawImage(t,e,s,i,n)}fillWithImage(t){const e=this.canvas.size;this.ctx.drawImage(t,0,0,e.x,e.y)}drawSprite(t,e,s,i,n,o,r,a,h){this.ctx.drawImage(t,e,s,i,n,o,r,a,h)}fillRect(t,e,s,i,n){this.fillStyle(n),this.ctx.fillRect(0|t,0|e,0|s,0|i)}fillCircle(t,e,s,i){this.fillStyle(i),this.ctx.beginPath(),this.ctx.ellipse(t,e,s,s,0,0,d),this.ctx.fill(),this.ctx.closePath()}fillStar(t,e,s,i,n,o){this.fillStyle(o),this.ctx.beginPath(),this.ctx.translate(t,e),this.ctx.moveTo(0,0-i);let r=Math.PI/s,a=0-n,h=0-i;for(let t=0;t<s;t++)this.ctx.rotate(r),this.ctx.lineTo(0,a),this.ctx.rotate(r),this.ctx.lineTo(0,h);this.ctx.closePath(),this.ctx.fill()}rotate(t,e=0,s=0){this.ctx.translate(e,s),this.ctx.rotate(t),this.ctx.translate(-e,-s)}resetRotation(){this.ctx.setTransform(1,0,0,1,0,0)}}const{WIDTH:R,HEIGHT:A}=e.CANVAS;class I extends i{constructor(){super(),this.scale=s(),this.shift=s(),this.size=s(),this.baseSize={x:R,y:A},this.aspectRatio=R/A,this._frame=new b(this),document.body.appendChild(this._frame.getBuffer()),this.fit()}get frame(){return this._frame}fit(){const t=window.innerWidth,e=window.innerHeight;let s,i;Math.min(t,e)===t?(i=Math.trunc(Math.min(e,t/this.aspectRatio)),s=Math.trunc(i*this.aspectRatio)):(s=Math.trunc(Math.min(t,e*this.aspectRatio)),i=Math.trunc(s/this.aspectRatio));const n=Math.trunc((t-s)/2),o=Math.trunc((e-i)/2);s===this.size.x&&i===this.size.y&&n===this.shift.x&&o===this.shift.y||(u.debugState({width:s,height:i}),this.size.x=s,this.size.y=i,this.scale={x:this.size.x/this.baseSize.x,y:this.size.y/this.baseSize.y},this.shift.x=n,this.shift.y=o,this._frame.setDimensions(this.size,this.shift),this.trigger("resize",this.size))}pixelToUnit(t,e){return{x:(t-this.shift.x)/this.scale.x,y:(e-this.shift.y)/this.scale.y}}}class O extends n{constructor(t){super(),this.buttonStates={},this.mousePos={x:0,y:0},this.canvas=t,this.key=this.key.bind(this),window.addEventListener("keydown",this.key),window.addEventListener("keyup",this.key),window.addEventListener("mousedown",this.key),window.addEventListener("mouseup",this.key),window.addEventListener("mousemove",t=>this.mousePositionUpdate("mousemove",t)),window.addEventListener("contextmenu",this.killEvent),window.addEventListener("blur",()=>this.clearAll()),window.addEventListener("resize",()=>this.canvas.fit())}killEvent(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()}key(t){switch(t.type){case"keydown":return t=t,void this.updateButtonsState(t.type,t.code,!0);case"keyup":return t=t,void this.updateButtonsState(t.type,t.code,!1);case"mousedown":return t=t,void this.updateButtonsState(t.type,"Mouse"+(t.button+1),!0);case"mouseup":return t=t,void this.updateButtonsState(t.type,"Mouse"+(t.button+1),!1)}}updateButtonsState(t,e,s){this.buttonStates[e]=s,this.queueEvent(t,e)}mousePositionUpdate(t,e){this.mousePos=this.canvas.pixelToUnit(e.pageX,e.pageY),this.queue.length&&this.queue[this.queue.length-1].event===t&&this.queue.pop(),this.queueEvent(t,this.mousePos)}clearAll(){for(let t of Object.keys(this.buttonStates)){let e=0===t.indexOf("Mouse")?"mouseup":"keyup";this.queueEvent(e,t),delete this.buttonStates[t]}}onKey(t,e,s){return super.on(t,e,s)}onMouseMove(t,e){return super.on("mousemove",t,e)}}class _{constructor(t,e=100){this.timer=0,this.lastTime=0,this.maxDelta=0,this.isRunning=!1,this.callback=t,this.maxDelta=e,this.run=this.run.bind(this)}start(){if(this.isRunning)return;this.isRunning=!0;const t=performance.now();let e=t-this.lastTime;e=e<this.maxDelta?e:0,this.lastTime=t-(this.maxDelta-e),this.timer=requestAnimationFrame(this.run)}run(){const t=performance.now(),e=t-this.lastTime;u.fps(e),this.callback(e<this.maxDelta?e:this.maxDelta).then(()=>{this.isRunning&&(this.lastTime=t,this.timer=requestAnimationFrame(this.run))})}stop(){this.isRunning=!1,0!==this.timer&&(cancelAnimationFrame(this.timer),this.timer=0)}}class D{constructor(){this.systems=[],this.queuedEntities=[],this.entities={},this.timeScale=1}init(){for(let t=0,e=this.systems.length;t<e;t++)this.systems[t].init()}destroy(){for(let t=0,e=this.systems.length;t<e;t++)this.systems[t].destroy()}addEntity(t){for(let e=0,s=this.systems.length;e<s;e++)this.systems[e].addIfCompatible(t);this.entities[t.ID]=t}queueEntity(t){this.queuedEntities.push(t),this.update=this.processAndReset}reCheckEntity(t){return this.addEntity(t)}removeEntity(t){for(let e=0,s=this.systems.length;e<s;e++)this.systems[e].removeEntity(t);delete this.entities[t]}processQueue(){for(let t=0,e=this.queuedEntities.length;t<e;t++)this.addEntity(this.queuedEntities[t]);this.queuedEntities=[]}updateSystems(t){const e=t*this.timeScale;for(let t=0,s=this.systems.length;t<s;t++)this.systems[t].update(e)}processAndReset(t){this.update=this.updateSystems,this.processQueue(),this.updateSystems(t)}update(t){this.updateSystems(t)}modifyEntities(t,e,s){let i=Object.values(this.entities);t.length&&(i=i.filter(e=>t.every(t=>e.hasOwnProperty(t)))),e.length&&(i=i.filter(t=>!e.some(e=>t.hasOwnProperty(e))));for(const t of i)s(t);i.forEach(t=>this.reCheckEntity(t))}}class T{constructor(t){this.name=t}addIfCompatible(t){return!1}removeEntity(t){}init(){}update(t){}destroy(){}}class k extends T{constructor(t,e=[],s=[]){super(t),this.entities={},this.required=e,this.notAllowed=s}isCompatible(t){return!(this.required.length&&this.required.some(e=>!(e in t))||this.notAllowed.length&&this.notAllowed.some(e=>e in t))}addIfCompatible(t){return this.isCompatible(t)?(this.entities[t.ID]=t,!0):(delete this.entities[t.ID],!1)}removeEntity(t){delete this.entities[t]}update(t){for(let e in this.entities)this.updateEntity(this.entities[e],t)}updateEntity(t,e){}}class C extends k{constructor(){super("Acceleration",["velocity","acceleration"],["isFrozen"])}updateEntity(t,e){t.velocity.x+=t.acceleration.x*e,t.velocity.y+=t.acceleration.y*e}}class F extends k{constructor(){super("AccelerationLimiter",["acceleration","maxAcceleration"])}updateEntity(t,e){v(t.acceleration,t.maxAcceleration)}}class L extends k{constructor(){super("Velocity",["velocity","position"],["isFrozen"])}updateEntity(t,e){t.position.x+=t.velocity.x*e,t.position.y+=t.velocity.y*e}}class P extends k{constructor(){super("VelocityLimiter",["velocity","maxVelocity"],["isFrozen"])}updateEntity(t,e){v(t.velocity,t.maxVelocity)}}class W extends T{constructor(t,e){super("FlushBuffer"),this.alpha=.1,this.output=t,this.frames=e}update(){this.output.alpha(this.alpha);for(const t of this.frames)this.output.fillWithImage(t.getBuffer());this.output.alpha(1)}}class q extends k{constructor(t){super("RectangleRender",["position","rectModel","rectColor","borderBox"]),this.frame=t}updateEntity(t,e){const s=t.position,i=t.borderBox;this.frame.fillRect(s.x-i.x/2,s.y-i.y/2,i.x,i.y,t.rectColor)}}const z={WORLD:{SIZE:{x:1920,y:1080}},SYSTEMS:{MOUSE_FOLLOWER_SYSTEM:{USE_MOUSE:!1,IS_FROZEN:!1,STOP_ON_REACH:!1,DESTROY_ON_REACH:!1,RESPAWN_ON_DESTROY:!0,LOOK_AHEAD_STEPS:0,RANDOM_FACTOR_SCALE:10,ACCELERATION_SCALE:y(1500)}}};let B={};const N="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";class V{static getId(){let t=Array(5).fill(0).map(()=>N[Math.floor(Math.random()*N.length)]).join("");return B[t]?this.getId():(B[t]=1,t)}static removeId(t){delete B[t]}static stats(){console.log("used "+Object.keys(B).length+" out of "+Math.pow(N.length,5)+" possibilities")}}class G{static createBasicEntity(){return{ID:V.getId(),hasChanged:!1}}static createMovingEntity(t=s(),e=s()){return{...this.createBasicEntity(),position:t,velocity:e}}static createAcceleratingEntity(t=s(),e=s(),i=s()){return{...this.createMovingEntity(t,e),acceleration:i}}}class H{static createRectModel(t,e){return{rectModel:!0,borderBox:{x:t,y:t},rectColor:e}}static getVectorInWorld(){return{x:x((t=z.WORLD.SIZE).x),y:x(t.y)};var t}static createSideScroller(){const t=this.getVectorInWorld();let e=x(20,4);e+=e%2;const s=p(e);return{...G.createMovingEntity(t,{x:s,y:0}),...this.createRectModel(e,"#ffffff20"),wrapAroundWorld:!0}}static getRandomColor(){return g()}static createMouseFollower(){const t=this.getVectorInWorld(),e=x(14,8);return{...G.createAcceleratingEntity(t),...this.createRectModel(e,g()),wrapAroundWorld:!0,mouseFollower:!0,explodes:!0,maxAcceleration:y(1e3),maxVelocity:p(500)}}static createExplosion(){return{...G.createBasicEntity(),position:s(),explosion:!0,explosionVelocity:2*p(500),explosionRadius:500,explosionModel:{color:g(),radius:250,lifeTime:1e3,progress:0}}}static createAnimatedStar(){const t=x(8,4),e=x(5,3),s=x(10,2),i=x(50,30),n=1e3*e,o=15*e,r=Math.random()>=.5?1:-1,a=class{static drawStar(t){const{numFrames:e,minRadius:s,maxRadius:i,fillStyle:n,numSpikes:o,lifeTime:r,opacityFactor:a,rotationDirection:h}=t,c=new OffscreenCanvas(2*i,2*i),l=c.getContext("2d");l.beginPath(),l.fillStyle=n,l.translate(i,i),l.moveTo(0,0-s);for(let t=0;t<o;t++)l.rotate(Math.PI/o),l.lineTo(0,0-i),l.rotate(Math.PI/o),l.lineTo(0,0-s);l.fill(),l.closePath();const u=new OffscreenCanvas(2*i*e,2*i),d=u.getContext("2d"),p=r/e,y=2*i,f=2*Math.PI/o;for(let t=0;t<e;t++){const e=p*t/r,s=Math.abs(e-.5)*a;if(s<.02)continue;d.globalAlpha=s;const n=f*e*h,o=y*t,l=o+i,u=i;d.translate(l,u),d.rotate(n),d.translate(-l,-u),d.drawImage(c,o,0,y,y),d.setTransform(1,0,0,1,0,0)}return u}}.drawStar({fillStyle:"#fff",lifeTime:n,maxRadius:i,minRadius:s,numFrames:o,numSpikes:t,opacityFactor:.4,rotationDirection:r}),h=this.getVectorInWorld(),c=p(w(10,15));return{...G.createMovingEntity(h,{x:Math.abs(c),y:0}),wrapAroundWorld:!0,starAnimation:{borderBox:{x:2*i,y:2*i},progress:x(n),lifeTime:n,numFrames:o,cache:a}}}static createRotatingGradient(t,e,s,i,n,o,r){const a=Object.values(r),h=Object.keys(r).map(t=>parseInt(t)/100);return{...G.createBasicEntity(),rotatingGradient:{size:t,angle:e,speed:s,radius:i,shiftX:n,shiftY:o,stops:h,colors:a}}}}class U extends T{constructor(t,e){if(super(t),this.entities={},e.length<2)throw"Can not create a MultiSystem with less than 2 groups, use System or EmptySystem instead";this.groups=e;for(let t of e)this.entities[t.name]={}}isCompatible(t,e){for(let s=0,i=t.components.length;s<i;s++)if(!(t.components[s]in e))return!1;return!0}addIfCompatible(t){let e=!1;for(let s=0;s<this.groups.length;s++){const i=this.groups[s],n=i.name;this.isCompatible(i,t)?(this.entities[n][t.ID]=t,e=!0):delete this.entities[n][t.ID]}return e}removeEntity(t){for(let e=0;e<this.groups.length;e++)delete this.entities[this.groups[e].name][t]}}class Y{static smoothStart(t,e){let s=t;for(;--e>0;)s*=t;return s}static smoothStop(t,e){let s=1-t;for(;--e>0;)s*=1-t;return 1-s}}class j extends U{constructor(){super("ExplosionDetection",[{name:"sources",components:["explosion","explosionVelocity","explosionRadius","position"]},{name:"targets",components:["explodes","velocity","position"]}])}update(t){if(function(t){for(let e in t)return!1;return!0}(this.entities.sources))return;const e=this.entities.sources,s=this.entities.targets;for(const t in e)for(const i in s)this.applyExplosion(e[t],s[i]);this.entities.sources={}}applyExplosion(t,e){const s={x:e.position.x-t.position.x,y:e.position.y-t.position.y},i=(s.x*s.x+s.y*s.y)/(t.explosionRadius*t.explosionRadius);if(i<1){const n=Y.smoothStart(1-i,3)*t.explosionVelocity,o=function(t){let e=f(t.x,t.y);return{x:Math.cos(e),y:-Math.sin(e)}}(s);e.velocity.x+=o.x*n,e.velocity.y+=o.y*n}}}class K extends k{constructor(t,e){super("ExplosionRender",["explosion","explosionModel","position"]),this.frame=t,this.ecs=e}updateEntity(t,e){const{explosionModel:s,position:i}=t;let{progress:n,lifeTime:o,color:r,radius:a}=s;if(t.explosionModel.progress=n+=e,n>=o)return this.ecs.removeEntity(t.ID);const h=n/o;a*=Y.smoothStop(h,5),r+=S(Math.trunc(256*(1-Y.smoothStop(h,10)))),this.frame.fillCircle(i.x,i.y,a,r)}}class Z extends k{constructor(t){super("GradientRender",["rotatingGradient"]),this.frame=t}updateEntity(t,e){const s=t.rotatingGradient;s.angle=(s.angle+e*s.speed+360)%360;const i=function(t){return{points:X(t.angle,...Q(t)),colors:t.colors,stops:t.stops}}(s);this.frame.renderGradientData(i)}}function Q(t){let e=0,s=0,i=Math[t.radius](t.size.x,t.size.y);switch(t.shiftX){case"center":e=t.size.x/2;break;case"left":e=0;break;case"right":e=t.size.x}switch(t.shiftY){case"center":s=t.size.y/2;break;case"top":s=0;break;case"bottom":s=t.size.y}return[i,e,s]}function X(t,e,s,i){const n=(t=(t+360)%360)*Math.PI/180,o=e/2;return function(t,e,s,i){let n=i-((e+=i)-i);return n=i-(n-i),[s-((t+=s)-s),n,t,e=i-(e-i)]}(o*Math.cos(n),o*Math.sin(n),s,i)}Math.atan2(9,16),Math.PI;class J extends T{constructor(t,e,s,i,n,o){super("InputSystem"),this.slowMoScale=.12,this.input=t,this.level=e,this.system=s,this.world=i,this.navigator=n,this.buffer=o}init(){this.input.onKey("keydown",this.handleKey,this),this.input.onKey("mousedown",this.mouseDown,this),this.input.onKey("mouseup",this.mouseUp,this)}mouseDown(t){if("Mouse1"===t){const t=H.createExplosion(),e=this.world.canvas.scale;t.position.x=this.input.mousePos.x*e.x,t.position.y=this.input.mousePos.y*e.y,this.level.queueEntity(t)}else"Mouse3"===t&&(this.level.timeScale=this.slowMoScale)}mouseUp(t){"Mouse3"===t&&(this.level.timeScale=1)}handleKey(t){switch(t){case"Enter":this.spawnMouseFollowers();break;case"Delete":this.removeMouseFollowers();break;case"Digit1":this.setMFSysParams(!1,!1,!0,0,0);break;case"Digit2":this.setMFSysParams(!0,!1,!0,200,0);break;case"Digit3":this.setMFSysParams(!1,!0,!0,50,0);break;case"Digit4":this.setMFSysParams(!1,!1,!1,0,1);break;case"Digit5":this.setMFSysParams(!1,!1,!1,0,z.SYSTEMS.MOUSE_FOLLOWER_SYSTEM.RANDOM_FACTOR_SCALE);break;case"Digit6":this.level.modifyEntities(["mouseFollower"],[],t=>{t.isFrozen?delete t.isFrozen:t.isFrozen=!0});break;case"Digit7":this.system.useMouse?(this.system.useMouse=!1,this.system.setTarget(this.navigator.getCurrent())):(this.system.useMouse=!0,this.setMFSysParams(!1,!1,!0,0,0),this.system.setTarget(this.input.mousePos));break;case"ArrowUp":this.buffer.alpha=Math.min(this.buffer.alpha+.05,1);break;case"ArrowDown":this.buffer.alpha=Math.max(this.buffer.alpha-.05,.15)}}setMFSysParams(t,e,s,i,n){this.system.stopOnReach=t,this.system.destroyOnReach=e,this.system.respawnOnDestroy=s,this.system.lookAheadSteps=i,this.system.randomFactorScale=n,this.system.updateSubRoutines()}spawnMouseFollowers(){for(let t=0;t<100;t++)this.level.queueEntity(H.createMouseFollower())}removeMouseFollowers(){let t=100;for(let e in this.system.entities)if(this.level.removeEntity(e),0==--t)break}destroy(){this.input.off("keydown",this.handleKey),this.input.off("mousedown",this.mouseDown),this.input.off("mouseup",this.mouseUp)}}const $=z.WORLD.SIZE,tt=z.SYSTEMS.MOUSE_FOLLOWER_SYSTEM;class et extends k{constructor(t,e){super("MouseFollowerSystem",["acceleration","position","velocity","mouseFollower","borderBox"],["isFrozen"]),this.useMouse=tt.USE_MOUSE,this.stopOnReach=tt.STOP_ON_REACH,this.destroyOnReach=tt.DESTROY_ON_REACH,this.respawnOnDestroy=tt.RESPAWN_ON_DESTROY,this.lookAheadSteps=tt.LOOK_AHEAD_STEPS,this.randomFactorScale=tt.RANDOM_FACTOR_SCALE,this.accelerationScale=tt.ACCELERATION_SCALE,this.target={x:$.x/2,y:$.y/2},this.input=t,this.ecs=e,this.updateSubRoutines()}init(){this.input.onMouseMove(this.mouseMove,this)}mouseMove(t){this.useMouse&&this.setTarget(t)}setTarget(t){var e,s;s=t,(e=this.target).x=s.x,e.y=s.y}updateSubRoutines(){this.getDirection=this.lookAheadSteps?this.getDirectionWithLookAhead:this.getDirectionNoLookAhead,this.scaleIfNeeded=this.randomFactorScale?this.scaleByRandom:()=>{}}updateEntity(t,e){if((this.destroyOnReach||this.stopOnReach)&&this.targetReached(t)){if(this.destroyOnReach){if(!this.respawnOnDestroy)return this.ecs.removeEntity(t.ID);t.rectColor=g(),t.position=H.getVectorInWorld(),E(t.velocity),E(t.acceleration)}return void(this.stopOnReach&&(E(t.velocity),E(t.acceleration)))}const s=this.getDirection(t);this.scaleIfNeeded(s),t.acceleration.x=s.x,t.acceleration.y=s.y}targetReached(t){let e=this.target.x-t.position.x,s=this.target.y-t.position.y;const i=e*e+s*s,n=t.borderBox;return n.x*n.x+n.y*n.y>i}getDirection(t){return console.error("called a dummy function"),t.acceleration}getDirectionWithLookAhead(t){const e=t.velocity,s=t.position;let i=m({x:s.x+e.x*this.lookAheadSteps,y:s.y+e.y*this.lookAheadSteps},this.target);return i.x*=this.accelerationScale,i.y*=this.accelerationScale,i}getDirectionNoLookAhead(t){const e=m(t.position,this.target);return e.x*=this.accelerationScale,e.y*=this.accelerationScale,e}scaleIfNeeded(t){console.error("called a dummy function")}scaleByRandom(t){t.x+=w()*this.randomFactorScale*this.accelerationScale,t.y+=w()*this.randomFactorScale*this.accelerationScale}destroy(){this.input.off("mousemove",this.mouseMove)}}const st=z.WORLD.SIZE;class it extends T{constructor(t,e){super("Navigator"),this.points=[s(.5*st.x,.5*st.y),s(.2*st.x,.3*st.y),s(.8*st.x,.7*st.y),s(.2*st.x,.7*st.y),s(.8*st.x,.3*st.y)],this.currentIndex=0,this.nextIndex=1,this.progress=0,this.interval=2e3,this.position=s(),this.mfs=t,this.frame=e}update(t){if(this.progress+=t,this.progress>=this.interval){this.progress=this.progress%this.interval,this.currentIndex=this.nextIndex;let t=x(this.points.length);t===this.nextIndex&&(t=(this.nextIndex+1)%this.points.length),this.nextIndex=t}this.mfs.useMouse||(this.updatePosition(),this.mfs.setTarget(this.position))}updatePosition(){const t=this.progress/this.interval,e=this.points[this.currentIndex],s=this.points[this.nextIndex];this.position.x=M(e.x,s.x,t),this.position.y=M(e.y,s.y,t)}getCurrent(){return this.position}}class nt extends k{constructor(t){super("StarAnimationRender",["starAnimation","position"]),this.frame=t}updateEntity(t,e){const{position:s,starAnimation:i}=t,{lifeTime:n,cache:o,borderBox:r,numFrames:a}=i,h=i.progress=(i.progress+e)%n,c=Math.floor(h/n*a),{x:l,y:u}=r;this.frame.drawSprite(o,l*c,0,l,u,s.x-l/2,s.y-u/2,l,u)}}const ot=z.WORLD.SIZE;class rt extends k{constructor(){super("WrapAroundWorld",["wrapAroundWorld","position"])}updateEntity(t){const{x:e,y:s}=t.position;t.position.x=e>ot.x?e%ot.x:e<0?ot.x:e,t.position.y=s>ot.y?s%ot.y:s<0?ot.y:s}}class at extends D{constructor(t){super(),this.world=t;const e=t.canvas,s=e.frame,i=this.world.input,n=new b(e),o=new et(i,this),r=new it(o,n),a=new W(s,[n]);this.systems=[new Z(n),new J(i,this,o,t,r,a),r,o,new j,new F,new C,new P,new L,new rt,new nt(n),new q(n),new K(n,this),a],this.queueEntity(H.createRotatingGradient(z.WORLD.SIZE,0,.05,"min","center","center",{0:"#400a",100:"#004a"}));for(let t=0;t<100;t++)this.queueEntity(H.createSideScroller());for(let t=0;t<100;t++)this.queueEntity(H.createAnimatedStar());for(let t=0;t<500;t++)this.queueEntity(H.createMouseFollower());this.init()}}class ht extends k{constructor(t,e,s){super("OpacityBuffer",["opacityAnimation"]),this.output=t,this.frames=e,this.ecs=s}update(t){this.output.clear();const e=this.getAlpha(t);this.output.alpha(e),this.frames.forEach(t=>this.output.fillWithImage(t.getBuffer())),this.output.alpha(1)}getAlpha(t){const e=Object.values(this.entities);if(0==e.length)return 1;console.assert(1===e.length);const s=e[0].opacityAnimation;s.progress=s.progress+t;const i=s.progress/s.lifeTime;return i>1?(this.ecs.world.setIdle(this),s.end):M(s.start,s.end,i)}}class ct extends D{constructor(t){super(),this.world=t;const e=t.canvas,s=e.frame,i=new b(e);this.systems=[new Z(i),new ht(s,[i],this)],this.queueEntity(H.createRotatingGradient(z.WORLD.SIZE,0,.05,"min","center","center",{0:"#a00",100:"#00a"}))}fade(){this.queueEntity({ID:"fade",opacityAnimation:{start:1,end:0,progress:0,lifeTime:5e3}})}}class lt{constructor(t,e,s){this.activeLevels=[],this.isPaused=!1,this.canvas=t,this.input=e,this.idleLevels=s.map(t=>new t(this))}init(){for(;this.idleLevels.length;){const t=this.idleLevels.shift();t.init(),this.activeLevels.push(t)}for(const t of this.activeLevels)t instanceof ct&&t.fade()}start(){this.isPaused=!1}pause(){this.isPaused=!0}destroy(){for(const t of this.activeLevels.concat(this.idleLevels))t.destroy()}update(t){if(this.isPaused)this.input.emptyQueue();else{this.input.executeQueue();for(const e of this.activeLevels)e.update(t)}}setIdle(t){const e=this.activeLevels.indexOf(t);-1!==e&&(this.activeLevels.splice(e,1),this.idleLevels.push(t))}}class ut{constructor(){this.isRunning=!1,this.canvas=new I,this.input=new O(this.canvas),this.worldManager=new lt(this.canvas,this.input,[at]),this.executer=new _(async t=>this.worldManager.update(t)),window.addEventListener("keydown",t=>{"Space"===t.code&&(this.isRunning?this.stop():this.start())})}start(){this.worldManager.start(),this.executer.start(),this.isRunning=!0,u.debugInfo("isRunning",this.isRunning.toString())}stop(){this.executer.stop(),this.worldManager.pause(),this.isRunning=!1,u.debugInfo("isRunning",this.isRunning.toString())}}window.addEventListener("load",()=>{try{!function(){if(null==new OffscreenCanvas(100,100).getContext("2d"))throw"Cannot get context";document.createElement("canvas").transferControlToOffscreen()}()}catch{return void(document.body.innerHTML="<h1>This page only works on Chromium based browsers because OffScreenCanvas is not fully supported yet <h1>")}const t=new ut;window.game=t,t.worldManager.init(),t.start()})})();</script>
  <noscript>
    This engine does not run without JavaScript!
  </noscript>
</body>

</html>
